; .eracs
;
; XXX Having dot files is probably a bad idea.  They should be more
; explicit and visible.
(use-modules (convenience-lambda)
             ((rnrs) #:select (vector-map vector-for-each mod))
             (system repl server)
             (zeroconf)
             (osc)
             (emacsy emacsy)
             (statprof)
             (logging))

(let ((orig emacsy-mode-line))
  (set! emacsy-mode-line 
        (lambda ()
          (format #f "~a FPS ~1,0f sim-time ~1,1f controller-time ~1,2f" 
                  (orig) 
                  (get-parameter 'FPS) 
                  (let ((sim (current-sim))) (if sim (sim-time sim) 0.))
                  (time-loop-value robot)))))

(let ((orig message))
  (set! message
        (lambda args
          (mylog "emacsy.message" pri-info (apply orig args)))))

(set! emacsy-log-error (lambda (format-msg . args)
                    (apply mylog "emacsy" pri-error format-msg args)))

(set! emacsy-log-warning (lambda (format-msg . args)
                    (apply mylog "emacsy" pri-warn  format-msg args)))

(set! emacsy-log-info (lambda (format-msg . args)
                    (apply mylog "emacsy" pri-info  format-msg args)))

(set! emacsy-log-debug (lambda (format-msg . args)
                    (apply mylog "emacsy" pri-debug  format-msg args)))


; (use-modules (system vm trace))
; (trace-calls-to-procedure make-stack)
(set! %load-hook (lambda (filename)
                   (mylog "load" pri-debug "Loading ~a .." filename)))
(define profile? #f)
(define spawn-threads? #t)

(define (stop-profiling)
    (statprof-stop)
    (statprof-display))

(when profile?
  (statprof-reset 0 50000 #t)
  (statprof-start)
  (add-hook! emacsy-terminate-hook stop-profiling))

;; Let's start a REPL.
(when spawn-threads?
  (spawn-server)


;; Let's start the OSC server and publish it.
  (start-osc-server)
  (spawn-publish-service "" "_osc._udp." "ERACS" 7770)
  ;; CTRL-c should still work but it doesn't after some threads are spawned.
  ;; This next line fixes that.
  (restore-signals))

(set-parameter! 'camera-position #(4 4 3))
(load "quadruped2.scm")
(load "record-robot.scm")
(load "hill-climber.scm")

;(optimize 1)
(restore-signals)
